<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Image Studio | Master Edition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8fafc">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .checkerboard {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%),
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .loader {
            border-top-color: #2563eb;
            animation: spinner 1s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bg-swatch {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .bg-swatch:hover {
            transform: translateY(-2px);
        }

        .bg-swatch.active {
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px #2563eb;
            transform: scale(1.05);
        }

        #workspace::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #workspace::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "onnxruntime-web": "./node_modules/onnxruntime-web/dist/ort.mjs"
        }
    }
    </script>
</head>

<body class="bg-slate-50 min-h-screen text-slate-900 overflow-hidden">

    <div class="flex h-screen flex-col lg:flex-row">

        <!-- Sidebar Controls -->
        <aside
            class="w-full lg:w-[380px] bg-white border-r border-slate-200 flex flex-col shadow-xl z-20 overflow-y-auto">
            <!-- Brand -->
            <div
                class="p-6 border-b border-slate-100 flex items-center gap-3 sticky top-0 bg-white/90 backdrop-blur-sm z-10">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">
                    P</div>
                <div>
                    <h1 class="text-sm font-extrabold tracking-tight uppercase">Precision Studio</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Master Workflow</p>
                </div>
            </div>

            <div class="p-6 space-y-8">

                <!-- 1. Import -->
                <section>
                    <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">01. Source Material
                    </h2>
                    <div id="importArea"
                        class="group relative flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:bg-blue-50/50 hover:border-blue-400 transition-all duration-300">
                        <div class="flex flex-col items-center justify-center py-5 pointer-events-none">
                            <svg class="w-8 h-8 text-slate-300 mb-2 group-hover:text-blue-500 transition-colors"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Click to Upload
                                Image</p>
                        </div>
                        <input id="imageInput" type="file" class="hidden" accept="image/*" />
                    </div>
                </section>

                <!-- 2. Dimensions -->
                <section id="resizePanel" class="opacity-40 pointer-events-none transition-opacity duration-500">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">02. Precise Scale
                    </h2>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                        <div class="flex items-center gap-3 px-1">
                            <input type="checkbox" id="lockRatio"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <label for="lockRatio" class="text-[11px] font-bold text-slate-600 uppercase">Lock Aspect
                                Ratio</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase ml-1">Width (px)</label>
                                <input type="number" id="widthInput"
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase ml-1">Height (px)</label>
                                <input type="number" id="heightInput"
                                    class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                            </div>
                        </div>
                        <button id="applyResize"
                            class="w-full py-3 bg-slate-900 text-white rounded-xl text-[10px] font-extrabold uppercase tracking-widest hover:bg-slate-800 transition-all shadow-md active:scale-95">Set
                            Dimensions</button>
                    </div>
                </section>

                <!-- 3. AI & Background -->
                <section id="aiPanel" class="opacity-40 pointer-events-none transition-opacity duration-500">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">03. AI Processing
                    </h2>
                    <div class="space-y-3 mb-6">
                        <button id="removeBgBtn"
                            class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-[10px] font-extrabold uppercase tracking-widest hover:shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 active:scale-95">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span>Extract Subject</span>
                        </button>
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <button id="undoBtn"
                                class="py-2 text-slate-400 rounded-xl text-[10px] font-bold hover:bg-slate-50 transition-all uppercase tracking-widest border border-slate-200 disabled:opacity-50"
                                disabled>Undo</button>
                            <button id="redoBtn"
                                class="py-2 text-slate-400 rounded-xl text-[10px] font-bold hover:bg-slate-50 transition-all uppercase tracking-widest border border-slate-200 disabled:opacity-50"
                                disabled>Redo</button>
                        </div>
                        <button id="resetBtn"
                            class="w-full py-2.5 text-slate-400 rounded-xl text-[10px] font-bold hover:bg-slate-50 transition-all uppercase tracking-widest border border-transparent hover:border-slate-100">
                            Reset to Original
                        </button>
                    </div>

                    <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-black text-slate-500 uppercase">Cleanup Eraser</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="brushToggle" class="sr-only peer">
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] font-bold text-slate-400">Size</span>
                            <input type="range" id="brushSize" min="5" max="150" value="20"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-100">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h3 class="text-[10px] font-black text-slate-500 uppercase">Background Fill</h3>
                            <span id="colorHex"
                                class="text-[9px] font-mono font-bold text-blue-500 uppercase tracking-tighter">transparent</span>
                        </div>
                        <div class="grid grid-cols-5 gap-3">
                            <button
                                class="bg-swatch active w-full aspect-square rounded-xl border border-slate-200 checkerboard"
                                data-color="transparent" title="Transparent"></button>
                            <button class="bg-swatch w-full aspect-square rounded-xl border border-slate-200 bg-white"
                                data-color="#ffffff" title="Solid White"></button>
                            <button class="bg-swatch w-full aspect-square rounded-xl border border-slate-200 bg-black"
                                data-color="#000000" title="Solid Black"></button>
                            <button
                                class="bg-swatch w-full aspect-square rounded-xl border border-slate-200 bg-slate-200"
                                data-color="#e2e8f0" title="Solid Gray"></button>
                            <button
                                class="bg-swatch w-full aspect-square rounded-xl border border-slate-200 bg-blue-500"
                                data-color="#3b82f6" title="Solid Blue"></button>

                            <div class="col-span-5 relative mt-2 group">
                                <input type="color" id="customColor"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                <div
                                    class="w-full py-3.5 border-2 border-slate-100 rounded-2xl text-[10px] font-black text-center text-slate-400 uppercase tracking-widest group-hover:bg-slate-50 group-hover:border-slate-200 transition-all flex items-center justify-center gap-3">
                                    <div id="customPreview"
                                        class="w-4 h-4 rounded-full border border-white bg-gradient-to-tr from-rose-500 via-yellow-400 to-indigo-500 transition-transform group-hover:scale-110">
                                    </div>
                                    Apply Custom Hex
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Export -->
            <div id="exportPanel"
                class="p-6 bg-slate-50 border-t border-slate-200 opacity-40 pointer-events-none sticky bottom-0 z-10">
                <button id="downloadBtn"
                    class="w-full py-4 bg-emerald-600 text-white rounded-xl text-xs font-black uppercase tracking-widest hover:bg-emerald-700 shadow-xl shadow-emerald-100 transition-all active:scale-95">Download
                    PNG</button>
            </div>
        </aside>

        <!-- Preview Workspace -->
        <main class="flex-1 bg-slate-100 p-8 lg:p-12 flex flex-col gap-6 overflow-hidden relative">
            <div id="workspace"
                class="flex-1 bg-slate-200/40 rounded-[2.5rem] border-4 border-white shadow-inner flex items-center justify-center overflow-auto relative backdrop-blur-sm">

                <!-- Empty State -->
                <div id="emptyState" class="text-center animate-pulse">
                    <div
                        class="w-24 h-24 bg-white/80 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-sm border border-white">
                        <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em]">Awaiting Asset Upload
                    </p>
                </div>

                <div id="canvasContainer"
                    class="hidden relative shadow-[0_30px_60px_-15px_rgba(0,0,0,0.4)] group transition-all duration-500">
                    <canvas id="mainCanvas"
                        class="max-w-full h-auto block rounded-sm border-2 border-white shadow-sm transition-opacity duration-300"></canvas>

                    <!-- Loading Mask -->
                    <div id="loadingOverlay"
                        class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-10 backdrop-blur-xl rounded-sm">
                        <div
                            class="loader ease-linear rounded-full border-4 border-t-4 border-slate-100 h-16 w-16 mb-8 shadow-sm">
                        </div>
                        <div class="w-48 h-1 bg-slate-200 rounded-full mb-6 overflow-hidden hidden"
                            id="progressContainer">
                            <div id="progressBar" class="h-full bg-blue-600 w-0 transition-all duration-300"></div>
                        </div>
                        <div class="text-center">
                            <p id="loadingStatusText"
                                class="text-[12px] font-black text-blue-600 uppercase tracking-[0.5em] animate-pulse">AI
                                Extraction</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-2">Semantic Pixel
                                Analysis</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="metaInfo"
                class="hidden flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] px-8">
                <div class="flex items-center gap-6">
                    <span class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
                        Original: <span id="sourceDim" class="text-slate-500 font-bold">0x0</span>
                    </span>
                    <span class="flex items-center gap-2 text-blue-600">
                        <div
                            class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse shadow-[0_0_8px_rgba(59,130,246,0.5)]">
                        </div>
                        Target: <span id="targetDim">0x0</span>
                    </span>
                </div>
                <div id="engineStatus" class="flex items-center gap-2 text-emerald-500">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div>
                    Atomic Render Active
                </div>
            </div>
        </main>
    </div>

    <!-- Notification -->
    <div id="toast"
        class="fixed bottom-10 right-10 px-8 py-4 bg-slate-900/90 backdrop-blur-md text-white text-[10px] font-black uppercase tracking-[0.3em] rounded-2xl opacity-0 pointer-events-none transition-all duration-500 shadow-2xl z-50 border border-white/10">
        Message
    </div>

    <script type="module">
        const apiKey = "";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'precision-studio-master-v3';

        const imageInput = document.getElementById('imageInput');
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const emptyState = document.getElementById('emptyState');
        const canvasContainer = document.getElementById('canvasContainer');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const lockRatio = document.getElementById('lockRatio');
        const colorHexLabel = document.getElementById('colorHex');
        const metaInfo = document.getElementById('metaInfo');

        // Core State
        const subjectCanvas = document.createElement('canvas');
        const sCtx = subjectCanvas.getContext('2d', { willReadFrequently: true });
        let originalImage = null;
        let currentSubject = null;
        let targetW = 0;
        let targetH = 0;
        let sourceRatio = 1;
        let fillColor = 'transparent';

        // Undo/Redo & Brush State
        let stateStack = [];
        let currentStateIndex = -1;
        let isDrawing = false;
        let isEraserEnabled = false;
        let currentBrushSize = 20;

        // UI Element References
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const brushToggle = document.getElementById('brushToggle');
        const brushSizeSlider = document.getElementById('brushSize');

        brushToggle.addEventListener('change', (e) => {
            isEraserEnabled = e.target.checked;
            mainCanvas.style.cursor = isEraserEnabled ? 'crosshair' : 'default';
        });

        brushSizeSlider.addEventListener('input', (e) => {
            currentBrushSize = parseInt(e.target.value);
        });

        function saveState() {
            if (!currentSubject) return;
            // Remove future states if we branch
            if (currentStateIndex < stateStack.length - 1) {
                stateStack = stateStack.slice(0, currentStateIndex + 1);
            }
            // Save current subjectCanvas DataURL
            stateStack.push(subjectCanvas.toDataURL('image/png'));
            // Max 10 states
            if (stateStack.length > 10) stateStack.shift();
            else currentStateIndex++;
            updateUndoRedoUI();
        }

        function loadState(index) {
            if (index < 0 || index >= stateStack.length) return;
            const img = new Image();
            img.onload = () => {
                subjectCanvas.width = img.width;
                subjectCanvas.height = img.height;
                sCtx.clearRect(0, 0, subjectCanvas.width, subjectCanvas.height);
                sCtx.drawImage(img, 0, 0);
                currentStateIndex = index;
                updateUndoRedoUI();
                render();
            };
            img.src = stateStack[index];
        }

        function updateUndoRedoUI() {
            if (undoBtn) undoBtn.disabled = currentStateIndex <= 0;
            if (redoBtn) redoBtn.disabled = currentStateIndex >= stateStack.length - 1;
        }

        undoBtn.addEventListener('click', () => loadState(currentStateIndex - 1));
        redoBtn.addEventListener('click', () => loadState(currentStateIndex + 1));

        // Setup Drawing on Main Canvas
        const getPointerPos = (e) => {
            const rect = mainCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const scaleX = mainCanvas.width / rect.width;
            const scaleY = mainCanvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        };

        const startDrawing = (e) => {
            if (!isEraserEnabled || !currentSubject) return;
            e.preventDefault();
            isDrawing = true;
            erasePoint(e);
        };

        const draw = (e) => {
            if (!isDrawing || !isEraserEnabled || !currentSubject) return;
            e.preventDefault();
            erasePoint(e);
        };

        const stopDrawing = (e) => {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        };

        const erasePoint = (e) => {
            const pos = getPointerPos(e);
            // Translate to subjectCanvas coordinates
            const sScaleX = subjectCanvas.width / targetW;
            const sScaleY = subjectCanvas.height / targetH;

            sCtx.globalCompositeOperation = 'destination-out';
            sCtx.beginPath();
            sCtx.arc(pos.x * sScaleX, pos.y * sScaleY, currentBrushSize * sScaleX, 0, Math.PI * 2);
            sCtx.fill();
            sCtx.globalCompositeOperation = 'source-over';
            render();
        };

        mainCanvas.addEventListener('mousedown', startDrawing);
        mainCanvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDrawing);
        mainCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        mainCanvas.addEventListener('touchmove', draw, { passive: false });
        window.addEventListener('touchend', stopDrawing);

        const handleImageFile = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    subjectCanvas.width = img.width;
                    subjectCanvas.height = img.height;
                    sCtx.clearRect(0, 0, subjectCanvas.width, subjectCanvas.height);
                    sCtx.drawImage(img, 0, 0);
                    currentSubject = subjectCanvas;

                    sourceRatio = img.width / img.height;
                    targetW = img.width;
                    targetH = img.height;

                    stateStack = [];
                    currentStateIndex = -1;
                    saveState();

                    // Extract colors with ColorThief
                    try {
                        if (img.complete) {
                            const palette = colorThief.getPalette(img, 4);
                            if (palette && palette.length >= 4) {
                                const swatches = document.querySelectorAll('.bg-swatch');
                                // Skip the first swatch (transparent)
                                for (let i = 0; i < 4; i++) {
                                    const hex = rgbToHex(palette[i][0], palette[i][1], palette[i][2]);
                                    swatches[i + 1].dataset.color = hex;
                                    swatches[i + 1].style.backgroundColor = hex;
                                    swatches[i + 1].title = `Auto Extracted: ${hex}`;
                                }
                            }
                        }
                    } catch (e) {
                        console.log("Color extraction skipped/failed: ", e);
                    }

                    activateUI(img.width, img.height);
                    render();
                    showToast("Asset Loaded Successfully");
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        imageInput.addEventListener('change', (e) => handleImageFile(e.target.files[0]));

        function rgbToHex(r, g, b) {
            return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1).toUpperCase();
        }

        document.getElementById('importArea').addEventListener('click', async () => {
            if (window.electronAPI) {
                const base64Data = await window.electronAPI.openFile();
                if (base64Data) {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        subjectCanvas.width = img.width;
                        subjectCanvas.height = img.height;
                        sCtx.clearRect(0, 0, subjectCanvas.width, subjectCanvas.height);
                        sCtx.drawImage(img, 0, 0);
                        currentSubject = subjectCanvas;

                        sourceRatio = img.width / img.height;
                        targetW = img.width;
                        targetH = img.height;

                        stateStack = [];
                        currentStateIndex = -1;
                        saveState();

                        // Extract colors with ColorThief
                        try {
                            if (img.complete) {
                                const palette = colorThief.getPalette(img, 4);
                                if (palette && palette.length >= 4) {
                                    const swatches = document.querySelectorAll('.bg-swatch');
                                    // Skip the first swatch (transparent)
                                    for (let i = 0; i < 4; i++) {
                                        const hex = rgbToHex(palette[i][0], palette[i][1], palette[i][2]);
                                        swatches[i + 1].dataset.color = hex;
                                        swatches[i + 1].style.backgroundColor = hex;
                                        swatches[i + 1].title = `Auto Extracted: ${hex}`;
                                    }
                                }
                            }
                        } catch (e) {
                            console.log("Color extraction skipped/failed: ", e);
                        }

                        activateUI(img.width, img.height);
                        render();
                        showToast("Asset Loaded Successfully");
                    };
                    img.src = `data:image/png;base64,${base64Data}`;
                }
            } else if (window.showOpenFilePicker) {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'Images', accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp'] } }]
                    });
                    const file = await fileHandle.getFile();
                    handleImageFile(file);
                } catch (e) {
                    // Ignore abort error
                }
            } else {
                imageInput.click();
            }
        });

        function activateUI(w, h) {
            emptyState.classList.add('hidden');
            canvasContainer.classList.remove('hidden');
            metaInfo.classList.remove('hidden');
            ['resizePanel', 'aiPanel', 'exportPanel'].forEach(id => {
                document.getElementById(id).classList.remove('opacity-40', 'pointer-events-none');
            });
            widthInput.value = w;
            heightInput.value = h;
            document.getElementById('sourceDim').textContent = `${w}x${h}`;
        }

        // 2. Resize Listeners
        widthInput.addEventListener('input', () => {
            if (lockRatio.checked) heightInput.value = Math.round(widthInput.value / sourceRatio);
        });

        heightInput.addEventListener('input', () => {
            if (lockRatio.checked) widthInput.value = Math.round(heightInput.value * sourceRatio);
        });

        document.getElementById('applyResize').addEventListener('click', () => {
            targetW = parseInt(widthInput.value) || originalImage.width;
            targetH = parseInt(heightInput.value) || originalImage.height;
            render();
            showToast(`Dimensions Commited: ${targetW}x${targetH}`);
        });

        // 3. Background Color Listeners
        document.querySelectorAll('.bg-swatch').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.bg-swatch').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                fillColor = btn.dataset.color;
                colorHexLabel.textContent = fillColor;
                render();
            });
        });

        document.getElementById('customColor').addEventListener('input', (e) => {
            document.querySelectorAll('.bg-swatch').forEach(b => b.classList.remove('active'));
            fillColor = e.target.value;
            document.getElementById('customPreview').style.background = fillColor;
            colorHexLabel.textContent = fillColor;
            render();
        });

        // Setup local ML models dynamically
        let removeBackground;
        let colorThief;

        // Use dynamic imports to catch and log errors, and prevent blocking
        (async () => {
            try {
                const imglyModule = await import('./node_modules/@imgly/background-removal/dist/index.mjs');
                removeBackground = imglyModule.removeBackground;

                const ctModule = await import('./node_modules/colorthief/dist/color-thief.mjs');
                // color-thief.mjs exports default
                const ColorThief = ctModule.default;
                colorThief = new ColorThief();
                console.log("Successfully loaded dynamic modules.");
            } catch (err) {
                console.error("Module loading failed:", err);
            }
        })();

        // 4. Advanced AI Background Removal
        document.getElementById('removeBgBtn').addEventListener('click', async () => {
            if (!originalImage) return; // Always extract from original for best quality
            setLoading(true);

            try {
                const statusText = document.getElementById('loadingStatusText');
                if (statusText) {
                    statusText.textContent = `Initializing Local AI...`;
                    statusText.classList.replace('text-rose-500', 'text-blue-600');
                }

                const pContainer = document.getElementById('progressContainer');
                const pBar = document.getElementById('progressBar');
                if (pContainer) pContainer.classList.remove('hidden');

                // Get image blob for imgly
                const blob = await new Promise(resolve => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = originalImage.width;
                    tempCanvas.height = originalImage.height;
                    const tCtx = tempCanvas.getContext('2d');
                    tCtx.drawImage(originalImage, 0, 0);
                    tempCanvas.toBlob(resolve, 'image/png');
                });

                // Run Local Background Removal
                const resultBlob = await removeBackground(blob, {
                    progress: (key, current, total) => {
                        if (pBar) {
                            const progress = Math.min((current / total) * 100, 100);
                            pBar.style.width = `${progress}%`;
                            if (statusText) statusText.textContent = `Processing: ${Math.round(progress)}%`;
                        }
                    }
                });

                const resImg = new Image();
                resImg.onload = () => {
                    subjectCanvas.width = resImg.width;
                    subjectCanvas.height = resImg.height;
                    sCtx.clearRect(0, 0, subjectCanvas.width, subjectCanvas.height);
                    sCtx.drawImage(resImg, 0, 0);

                    currentSubject = subjectCanvas;
                    saveState();
                    render();
                    setLoading(false);
                    if (pContainer) pContainer.classList.add('hidden');
                    if (statusText) statusText.textContent = 'AI Extraction';
                    showToast("Local Extraction Complete");
                };
                resImg.src = URL.createObjectURL(resultBlob);

            } catch (err) {
                console.error(err);
                setLoading(false);
                const pContainer = document.getElementById('progressContainer');
                if (pContainer) pContainer.classList.add('hidden');
                showToast("Extraction Failed");
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (!originalImage) return;
            subjectCanvas.width = originalImage.width;
            subjectCanvas.height = originalImage.height;
            sCtx.clearRect(0, 0, subjectCanvas.width, subjectCanvas.height);
            sCtx.drawImage(originalImage, 0, 0);
            currentSubject = subjectCanvas;
            saveState();
            render();
            showToast("Restored Original Material");
        });

        // 5. Atomic Rendering Sequence
        function render() {
            if (!currentSubject) return;

            // Step 1: Force Canvas Scale
            mainCanvas.width = targetW;
            mainCanvas.height = targetH;

            // Apply High Quality Interpolation
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Step 2: Atomic Wipe
            ctx.clearRect(0, 0, targetW, targetH);

            // Step 3: Solid Background Fill (Atomic Layer)
            if (fillColor !== 'transparent') {
                ctx.fillStyle = fillColor;
                ctx.fillRect(0, 0, targetW, targetH);
                canvasContainer.classList.remove('checkerboard');
                canvasContainer.style.backgroundColor = fillColor;
            } else {
                canvasContainer.classList.add('checkerboard');
                canvasContainer.style.backgroundColor = 'transparent';
            }

            // Step 4: Subject Overlay (Direct Stretch)
            ctx.drawImage(currentSubject, 0, 0, targetW, targetH);

            document.getElementById('targetDim').textContent = `${targetW}x${targetH}`;
        }

        // 6. Distribution
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const dataUrl = mainCanvas.toDataURL('image/png');

            if (window.electronAPI) {
                const base64Data = dataUrl.split(',')[1];
                const success = await window.electronAPI.saveFile(base64Data);
                if (success) {
                    showToast("File Dispatched to Local Drive");
                }
            } else if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'precision-studio-out.png',
                        types: [{ description: 'PNG Image', accept: { 'image/png': ['.png'] } }]
                    });
                    const writable = await handle.createWritable();
                    const response = await fetch(dataUrl);
                    const blob = await response.blob();
                    await writable.write(blob);
                    await writable.close();
                    showToast("File Dispatched to Local Drive");
                } catch (e) {
                    // Ignore abort error
                }
            } else {
                const link = document.createElement('a');
                link.download = `precision-studio-out.png`;
                link.href = dataUrl;
                link.click();
                showToast("File Dispatched to Local Drive");
            }
        });

        function setLoading(isLoading) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !isLoading);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>

</html>